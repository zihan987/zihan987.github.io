<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Tengine支持PaddlePaddle2.0啦 | 阿chai带你学AI</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://zihan987.github.io/favicon.ico?v=1628773680870">
<link rel="stylesheet" href="https://zihan987.github.io/styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  


<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="Tengine是非常优秀的深度学习推理框架，之前阿chai也出过很多Tengine的教程，今天我们介绍一下如何将PaddlePaddle2.0的模型转换Tengine。


如果对Tengine不了解的可以看阿柴之前写的教程：

面向芯片的..." />
    <meta name="keywords" content="算法侧端部署" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://zihan987.github.io">
        <img src="https://zihan987.github.io/images/avatar.png?v=1628773680870" class="site-logo">
        <h1 class="site-title">阿chai带你学AI</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            迷你小窝
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            推文整理
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            标签分类
          </a>
        
      
        
          <a href="https://zihan987.github.io" class="site-nav">
            资源整理
          </a>
        
      
        
          <a href="https://zihan987.github.io/post/a-chai-jian-jie" class="site-nav">
            关于阿chai
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
          <a class="social-link" href="https://github.com/zihan987" target="_blank">
            <i class="fab fa-github"></i>
          </a>
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      小镇青年，不偷电瓶，chai哩chai气
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/zihan987" target="_blank">紫涵</a> | <a class="rss" href="https://zihan987.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Tengine支持PaddlePaddle2.0啦</h2>
            <div class="post-date">2021-08-10</div>
            
              <div class="feature-container" style="background-image: url('https://zihan987.github.io/post-images/tengine-zhi-chi-paddlepaddle20-la.png')">
              </div>
            
            <div class="post-content" v-pre>
              <p>Tengine是非常优秀的深度学习推理框架，之前阿chai也出过很多Tengine的教程，今天我们介绍一下如何将PaddlePaddle2.0的模型转换Tengine。</p>
<!-- more -->
<figure data-type="image" tabindex="1"><img src="https://mmbiz.qpic.cn/mmbiz_jpg/gIb5Pv6jCfdTpRaLnyIUQia7BZMqiazHp9GiaibpmF99bo4VLquSJ1Jf0PldSecOCBJWcpYkJmiaFcp0zZQ2CVBzDtg/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片" loading="lazy"></figure>
<p>如果对Tengine不了解的可以看阿柴之前写的教程：</p>
<ul>
<li><a href="http://mp.weixin.qq.com/s?__biz=MzIzNDAwNzA4OQ==&amp;mid=2247483767&amp;idx=1&amp;sn=d2536c4d481278bdae2af1df9190ea43&amp;chksm=e8fdbe29df8a373f25ad5a44ae29ce9b1460e3ebdfd4ca15a0223af621eef9659f2f3065d10e&amp;scene=21#wechat_redirect">面向芯片的推理框架Tengine-Lite</a></li>
<li><a href="http://mp.weixin.qq.com/s?__biz=MzIzNDAwNzA4OQ==&amp;mid=2247486235&amp;idx=1&amp;sn=9e5818eb60ecc0ef7976ce4feeeb3799&amp;chksm=e8fdb445df8a3d5382163abaae7c15ed3f59406ed713a5437023ca234a7fb7c557d6a7867c09&amp;scene=21#wechat_redirect">Khadas VIM3上进行Tengine模型推理</a></li>
<li><a href="http://mp.weixin.qq.com/s?__biz=MzIzNDAwNzA4OQ==&amp;mid=2247485908&amp;idx=1&amp;sn=848793deed0ceec65c679fd1963f9da0&amp;chksm=e8fdb68adf8a3f9c5794626fa43c34632f38ea9eea35e8a9de467f46fa3d64ef22fd70ff716c&amp;scene=21#wechat_redirect">Tengine在GPU上支持CUDA/TensorRT加速啦</a></li>
<li><a href="http://mp.weixin.qq.com/s?__biz=MzIzNDAwNzA4OQ==&amp;mid=2247486258&amp;idx=1&amp;sn=5aad6a94cb057650f17df55ecf4fd72f&amp;chksm=e8fdb46cdf8a3d7a9ab7fa923bd639b5bf558e810e598518c26b953275f4f84fb29248199123&amp;scene=21#wechat_redirect">Tengine 支持 NPU 模型部署-YOLOv5s</a></li>
</ul>
<p>本文参考圈圈虫大佬的Tengine 支持 PaddlePaddle 模型部署。</p>
<h3 id="动态图与计算图">动态图与计算图</h3>
<p>百度的PadddlePaddle2.0支持了非常好用的动态图：</p>
<p>(1)动态图: 运算和图结构搭建同时进行，主要特点为灵活、便于修改</p>
<p>(2)静态图: 先搭建图结构，后进行运算，主要特点为效率高、不好改</p>
<p>但是如果将深度学习模型部署的话计算图会好一些。</p>
<p>PaddlePaddle计算图的CNN：</p>
<pre><code>import paddle.fluid as f
import numpy as np

data = f.layers.data(name='data', shape=[3, 32, 32], dtype='float32')
param_attr = f.ParamAttr(name='conv2d.weight', initializer=f.initializer.Xavier(uniform=False), learning_rate=0.001)

res = f.layers.conv2d(input=data, num_filters=2, filter_size=3, act=&quot;relu&quot;, param_attr=param_attr)

place = f.CPUPlace()
exe = f.Executor(place)
exe.run(f.default_startup_program())

x = np.random.rand(1, 3, 32, 32).astype(&quot;float32&quot;)

res_output = exe.run(feed={&quot;data&quot;: x}, fetch_list=[res])
</code></pre>
<p>PaddlePaddle 动态图CNN：</p>
<pre><code>from paddle.fluid.dygraph.base import to_variable
import paddle.fluid as f
from paddle.fluid.dygraph import Conv2D
import numpy as np

x = np.random.rand(1, 3, 32, 32).astype(&quot;float32&quot;)

with f.dygraph.guard():
    conv2d = Conv2D(num_channels=3,
                    num_filters=2,
                    filter_size=3,
                    act='relu')
    data = to_variable(x)
    conv = conv2d(data)
</code></pre>
<h3 id="环境准备">环境准备</h3>
<p>先放上阿chai的测试环境：</p>
<table>
<thead>
<tr>
<th style="text-align:left">设备</th>
<th style="text-align:left">操作系统</th>
<th style="text-align:left">内存</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">CPU云服务器(2核)</td>
<td style="text-align:left">Ubuntu18.0.4</td>
<td style="text-align:left">4G</td>
</tr>
</tbody>
</table>
<p>1.安装PaddlePaddle：</p>
<pre><code>pip3 install paddlepaddle --upgrade -i https://mirror.baidu.com/pypi/simple
</code></pre>
<p>2.安装paddleclas：</p>
<pre><code>git clone https://github.com/PaddlePaddle/PaddleClas.git

# 安装依赖
pip3 install --upgrade -r requirements.txt -i https://mirror.baidu.com/pypi/simple
</code></pre>
<p>requirements.txt中的gast建议安装成0.3.3的版本：</p>
<pre><code>pip3 install gast==0.3.3 -i http://pypi.douban.com/simple/
</code></pre>
<p>3.编译Tengine-Convert-Tools:</p>
<pre><code>sudo apt install libprotobuf-dev protobuf-compiler

git clone  https://github.com/OAID/Tengine-Convert-Tools.git

mkdir build &amp;&amp; cd build
cmake .. &amp;&amp; make
</code></pre>
<p>4.编译Tengine：</p>
<pre><code>sudo apt-get install cmake make g++ git

git clone -b tengine-lite https://github.com/OAID/Tengine.git  Tengine-Lite

cd Tengine-Lite
mkdir build 
cd build
cmake ..
make -j2
make install
</code></pre>
<p>如果出现CMake版本太低，因为经常有使用国内镜像的，所以可能会出现cmake版本低的情况，这里我附上版本3.20.0的安装方式。</p>
<pre><code>wget https://cmake.org/files/v3.20/cmake-3.20.0-rc4-linux-x86_64.tar.gz

tar -zxvf cmake-3.12.2-Linux-x86_64.tar.gz

#在环境变量中添加export PATH=$PATH:/home/username/filepath/cmake-3.12.2-Linux-x86_64/bin

source ~/.bashrc 

chmod 777 cmake ccmake cmake-gui cpack ctest
</code></pre>
<h3 id="模型转换">模型转换</h3>
<p>1.下载模型：</p>
<pre><code>wget https://link.zhihu.com/?target=https%3A//paddle-imagenet-models-name.bj.bcebos.com/dygraph/MobileNetV2_pretrained.pdparams
</code></pre>
<p>2.依托动态图转换为计算图：</p>
<pre><code>python3 tools/export_model.py --model MobileNetV2 --pretrained_model ./output/MobileNetV2_pretrained --output_path ./inference --class_dim 1000
</code></pre>
<p>静态图的模型文件存放在 inference 目录下，包含以下三个文件：</p>
<table>
<thead>
<tr>
<th style="text-align:left">文件名</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">inference.pdmodel</td>
<td style="text-align:left">网络结构文件，类似 Caffe 的 prototxt 文件，用于保存 graph 中 node 间连接关系，可以用 Netron 打开进行可视化。</td>
</tr>
<tr>
<td style="text-align:left">inference.pdiparams</td>
<td style="text-align:left">网络参数文件，类似 Caffe 的 caffemodel 文件，用于保存 weight、bias 等参数数据。</td>
</tr>
<tr>
<td style="text-align:left">http://inference.pdiparams.info</td>
<td style="text-align:left">临时文件，据说重训练时会用到 ？？？</td>
</tr>
</tbody>
</table>
<p>3.转换为tmfile：</p>
<pre><code># 路径设置成自己的
./convert_tool -f paddle -p inference.pdmodel -m inference.pdiparams -o mobilenetv2_paddle.tmfile
</code></pre>
<h3 id="测试">测试</h3>
<pre><code>./tm_classification -m /root/Desktop/Paddle2/mobilenetv2_paddle.tmfile -i /root/Desktop/Paddle2/cat.jpeg -g 224,224 -s 0.017,0.017,0.017 -r 10
Mean value not specified, use default   104.0, 116.7, 122.7
tengine-lite library version: 1.4-dev

model file : /root/Desktop/Paddle2/mobilenetv2_paddle.tmfile
image file : /root/Desktop/Paddle2/cat.jpeg
img_h, img_w, scale[3], mean[3] : 224 224 , 0.017 0.017 0.017, 104.0 116.7 122.7
Repeat 10 times, thread 1, avg time 46.50 ms, max_time 51.41 ms, min_time 44.26 ms
--------------------------------------
0.317292, 281
0.176262, 285
0.154328, 282
0.039242, 287
0.029589, 278
--------------------------------------
</code></pre>
<p>上面是阿chai测试的结果。</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://zihan987.github.io/tag/SH-93dAGg/" class="tag">
                    算法侧端部署
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://zihan987.github.io/post/tengine-zhi-chi-npu-mo-xing-bu-shu-yolov5s/">
                  <h3 class="post-title">
                    Tengine 支持 NPU 模型部署-YOLOv5s
                  </h3>
                </a>
              </div>
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>




  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: 'a40607f1d70a0647fef5',
        clientSecret: '12cc803752e081722178f5b0356f8fc61fe8a607',
        repo: 'zihan987.github.io',
        owner: 'zihan987',
        admin: ['zihan987'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  




  </body>
</html>
